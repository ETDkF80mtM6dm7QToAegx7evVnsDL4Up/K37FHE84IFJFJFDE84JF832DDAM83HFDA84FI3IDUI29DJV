<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cook with recipe</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@700;900&family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    :root {
        --primary: #FFC107;
        --primary-dark: #FFA000;
        --accent: #FF5722;
        --bg: #FAFAFA;
        --card-bg: #FFFFFF;
        --text-main: #1a1a1a;
        --text-light: #666666;
        --border: #E0E0E0;
        --shadow: 0 5px 20px rgba(0,0,0,0.05);
        --radius: 16px;
        --nav-bg: #FFFFFF;
        --nav-height: 80px;
    }

    [data-theme="dark"] {
        --bg: #121212;
        --card-bg: #1E1E1E;
        --text-main: #FFFFFF;
        --text-light: #B0B0B0;
        --border: #333333;
        --nav-bg: #1E1E1E;
        --shadow: 0 5px 20px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'DM Sans', sans-serif;
        background-color: var(--bg);
        color: var(--text-main);
        height: 100vh;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        font-size: 15px;
    }

    .btn-bounce { transition: transform 0.1s; cursor: pointer; }
    .btn-bounce:active { transform: scale(0.96); }
    
    input, select, textarea {
        background: var(--card-bg); color: var(--text-main);
        border: 1px solid var(--border);
        font-size: 16px; 
        width: 100%;
        border-radius: 12px;
        outline: none;
        appearance: none;
        font-family: 'DM Sans', sans-serif;
    }

    header {
        padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        z-index: 100;
        flex-shrink: 0;
        height: 60px;
    }
    .logo { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 900; }
    .logo span { color: var(--primary); margin-right: 10px; }

    .view-section {
        flex: 1; 
        width: 100%; 
        max-width: 600px; 
        margin: 0 auto;
        display: none; 
        padding: 10px 20px calc(var(--nav-height) + 10px) 20px;
        overflow-y: hidden; 
    }

    #view-result, #view-history {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* CHAT VIEW STYLES */
    #view-chat {
        display: none;
        flex-direction: column;
        padding: 0; /* Full screen */
        background: var(--bg);
        height: 100%;
        position: relative;
    }
    
    .chat-header {
        padding: 20px;
        display: flex;
        align-items: flex-start;
        gap: 15px;
    }
    .chat-back-btn {
        font-size: 1.5rem;
        padding: 5px;
        cursor: pointer;
    }
    .chat-titles h1 {
        font-family: 'Playfair Display', serif;
        font-size: 1.8rem;
        line-height: 1;
        margin-bottom: 5px;
    }
    .chat-titles p {
        font-family: 'Inter', sans-serif;
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .chat-center {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        padding-bottom: 80px; /* Space for input */
    }

    .chef-circle-wrapper {
        position: relative;
        width: 160px;
        height: 160px;
        display: flex;
        justify-content: center;
    }

    .chef-circle {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: var(--card-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        border: 4px solid var(--primary);
        box-shadow: 0 0 30px rgba(255, 193, 7, 0.3);
        transition: box-shadow 0.3s, border-color 0.3s;
        z-index: 10;
        position: absolute;
        bottom: 0;
    }

    /* Error state for circle */
    .chef-circle.error-glow {
        border-color: #ef5350;
        box-shadow: 0 0 40px rgba(239, 83, 80, 0.6);
    }

    .chat-bubble {
        position: absolute;
        bottom: 150px; /* Above circle */
        background: var(--card-bg);
        padding: 15px 20px;
        border-radius: 20px 20px 20px 0;
        box-shadow: var(--shadow);
        max-width: 80%;
        min-width: 100px;
        text-align: center;
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
        line-height: 1.4;
        opacity: 0;
        transform: translateY(10px) scale(0.9);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: none;
    }
    .chat-bubble.show {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    
    /* Typing dots */
    .typing-dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: var(--text-light);
        border-radius: 50%;
        margin: 0 2px;
        animation: wave 1.3s linear infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: -1.1s; }
    .typing-dots span:nth-child(3) { animation-delay: -0.9s; }
    @keyframes wave {
        0%, 60%, 100% { transform: initial; }
        30% { transform: translateY(-7px); }
    }

    .chat-input-area {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 20px;
        background: var(--bg);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .chat-input {
        flex: 1;
        padding: 15px;
        border-radius: 30px;
        border: 1px solid var(--border);
        background: var(--card-bg);
    }
    .send-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary);
        color: #000;
        border: none;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
    }


    /* END CHAT VIEW STYLES */

    .view-section.active { display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .hero-title { font-family: 'Playfair Display', serif; font-size: 2.2rem; line-height: 1.1; margin-bottom: 5px; }
    .subtitle { color: var(--text-light); margin-bottom: 20px; font-size: 1rem; }
    .input-label { font-size: 0.85rem; font-weight: 700; color: var(--text-light); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }

    textarea { height: 100px; padding: 14px; resize: none; margin-bottom: 15px; }
    textarea:focus { border-color: var(--primary); }
    select, input[type="text"] { padding: 12px; }

    .btn-primary {
        background: var(--primary); color: #000; border: none; width: 100%; 
        padding: 16px; border-radius: var(--radius); font-size: 1.1rem; font-weight: 700;
        box-shadow: 0 8px 20px rgba(255, 193, 7, 0.25); margin-top: 10px;
        display: flex; align-items: center; justify-content: center; gap: 8px;
    }

    .top-recipes-wrapper { margin-top: auto; padding-bottom: 10px; }
    .top-recipes-list { display: flex; justify-content: center; gap: 15px; }
    .top-bubble {
        width: 65px; height: 65px; border-radius: 50%; border: 2px solid var(--card-bg);
        box-shadow: var(--shadow); cursor: pointer; position: relative;
    }
    .top-bubble img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .top-bubble span {
        position: absolute; top: -2px; right: -2px; background: var(--primary); color: #000;
        font-size: 0.75rem; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;
        border-radius: 50%; font-weight: bold; border: 2px solid var(--card-bg);
    }

    .settings-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px; }
    .setting-row { margin-bottom: 15px; }
    .switch-row { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; font-weight: 500;}
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    .recipe-header {
        background: var(--card-bg); padding: 0 0 20px 0; border-radius: var(--radius);
        box-shadow: var(--shadow); margin-bottom: 20px; text-align: center; overflow: hidden;
    }
    .recipe-img { width: 100%; height: 250px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; }
    
    .recipe-info-container { padding: 0 20px; }
    
    /* New 4-Card Meta Grid */
    .meta-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
    .meta-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: var(--bg); padding: 12px 5px; border-radius: 14px; 
        font-size: 0.85rem; font-weight: 700; color: var(--text-main);
    }
    .meta-item i { color: var(--primary-dark); margin-bottom: 6px; font-size: 1.1rem; }

    .meter-container { margin-top: 15px; padding: 8px; border: 1px solid var(--border); border-radius: 12px; }
    .meter-track { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin-top: 5px;}
    .meter-fill { height: 100%; background: linear-gradient(90deg, #81C784, #FFB74D, #E57373); }

    .ing-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .ing-pencil { 
        width: 35px; height: 35px; margin-right: 12px; background: #f5f5f5; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: var(--text-light); cursor: pointer; font-size: 0.9rem; flex-shrink: 0;
    }
    .ing-pencil.active { background: var(--accent); color: white; }
    .ing-text { flex: 1; font-size: 1.05rem; }
    .ing-missing { text-decoration: line-through; color: var(--text-light); opacity: 0.5; }
    
    .step-card {
        background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 15px;
        border-left: 4px solid var(--primary); box-shadow: var(--shadow); position: relative;
    }
    .step-text { font-size: 1.05rem; line-height: 1.5; margin-bottom: 10px; }
    
    .step-cam-btn {
        background: var(--bg); color: var(--text-main); border: 1px solid var(--border);
        padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;
        display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
    }
    .step-cam-btn i { color: var(--accent); }

    .action-row { display: flex; justify-content: center; gap: 20px; margin: 25px 0; }
    .round-btn {
        width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--border);
        background: var(--card-bg); color: var(--text-light); font-size: 1.4rem;
        display: flex; align-items: center; justify-content: center;
    }
    /* Chat Trigger Button Specifics */
    .round-btn.chat-trigger {
        border-color: var(--primary);
        background: var(--primary);
        color: #000;
        box-shadow: 0 5px 15px rgba(255,193,7,0.3);
    }

    #loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg); z-index: 2000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
    }
    .emoji-anim { font-size: 4rem; animation: bounce 1s infinite alternate; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-15px); } }

    #toast {
        visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center;
        border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 6000; left: 50%; bottom: 100px;
        transform: translateX(-50%); font-size: 0.9rem; opacity: 0; transition: opacity 0.3s;
    }
    #toast.show { visibility: visible; opacity: 1; }

    /* Offline/Unsafe Modal */
    #offline-modal, #unsafe-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 7000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center; padding: 30px;
        animation: fadeIn 0.3s;
    }

    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: var(--nav-bg);
        display: flex; align-items: center; justify-content: space-evenly;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-radius: 25px 25px 0 0;
        padding-bottom: 5px;
    }
    .nav-item { font-size: 1.4rem; color: #ccc; padding: 20px; }
    .nav-item.active { color: var(--text-main); }
    .fab {
        width: 60px; height: 60px; background: var(--primary); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: #000;
        transform: translateY(-25px); border: 6px solid var(--bg); box-shadow: 0 5px 15px rgba(255,193,7,0.4);
    }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
        z-index: 3500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
    }
    .modal-box {
        background: var(--card-bg); width: 85%; max-width: 320px; padding: 25px;
        border-radius: 20px; text-align: center; animation: fadeIn 0.3s;
    }

    /* AI Cam Modal */
    #ai-cam-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 6000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
        padding: 30px; text-align: center;
    }
    .ai-result-box {
        background: var(--card-bg); width: 100%; max-width: 350px;
        padding: 30px; border-radius: 24px; color: var(--text-main);
        display: flex; flex-direction: column; align-items: center;
    }
    
    /* Meter UI for AI */
    .meter-circle {
        width: 100px; height: 100px; border-radius: 50%;
        background: conic-gradient(var(--meter-color) var(--meter-val), #eee 0deg);
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 20px; transition: 0.5s;
    }
    .meter-inner {
        width: 80px; height: 80px; background: var(--card-bg); border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; font-weight: 900;
    }

    .responsive-flex { display: flex; gap: 10px; margin-bottom: 15px; }
</style>

<script type="importmap">
  { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
</script>
</head>
<body>
<header>
    <div class="logo">Kema<span>.</span></div>
</header>

<div id="toast">Message</div>

<!-- Offline Modal -->
<div id="offline-modal">
    <div style="font-size: 4rem;">üçΩÔ∏è</div>
    <h1 style="font-family:'Playfair Display'; margin: 20px 0 10px;">Oops!</h1>
    <p style="font-size: 1.1rem; line-height: 1.5; opacity: 0.9;">The chef needs internet to create recipes.<br>Please connect to a network.</p>
</div>

<!-- Unsafe Modal -->
<div id="unsafe-modal">
    <div style="font-size: 4rem;">üõë</div>
    <h1 style="font-family:'Playfair Display'; margin: 20px 0 10px;">Warning</h1>
    <p style="font-size: 1.1rem; line-height: 1.5; opacity: 0.9; margin-bottom:20px;" id="unsafe-msg">I cannot cook with that.<br>Please enter valid food ingredients.</p>
    <button class="btn-primary" style="background:transparent; color:white; border:2px solid white; width:auto; padding:10px 30px;" onclick="closeUnsafe()">Try Again</button>
</div>

<!-- AI Feedback Modal -->
<div id="ai-cam-modal">
    <div class="ai-result-box">
        <div class="meter-circle" id="ai-meter" style="--meter-val: 0%; --meter-color: #ccc;">
            <div class="meter-inner" id="ai-meter-text">?</div>
        </div>
        <h3 id="ai-cam-title" style="margin-bottom:10px;">Analyzing...</h3>
        <p id="ai-cam-msg" style="color:var(--text-light); line-height:1.5; margin-bottom:20px;">Please wait while I look at your food.</p>
        <button class="btn-primary" onclick="closeAiCam()">Okay</button>
    </div>
</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
        <h3 style="margin-bottom:10px; font-size:1.3rem;">Delete Everything?</h3>
        <p style="color:var(--text-light); margin-bottom:20px; font-size: 0.9rem;">This action cannot be undone.</p>
        <button class="btn-primary" style="background:#ef5350; color:white; margin-bottom:10px; box-shadow:none; padding:12px;" onclick="performDelete()">Delete</button>
        <button class="btn-primary" style="background:transparent; color:var(--text-main); border:1px solid var(--border); box-shadow:none; padding:12px;" onclick="closeConfirm()">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="nutriModal">
    <div class="modal-box">
        <h3 style="margin-bottom:20px; font-family:'Playfair Display', serif;">Nutrition Facts</h3>
        <div id="nutriContent"></div>
        <button class="btn-primary" style="margin-top:20px; padding:12px;" onclick="document.getElementById('nutriModal').style.display='none'">Close</button>
    </div>
</div>

<div id="loader">
    <div class="emoji-anim">üç≥</div>
    <div style="margin-top:20px; font-weight:bold; color:var(--text-light); font-size:1.2rem;" id="loader-text">Cooking...</div>
</div>

<!-- Hidden File Input for Camera -->
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">

<!-- HOME VIEW -->
<div id="view-home" class="view-section active">
    <div>
        <h1 class="hero-title">What's in your<br>kitchen?</h1>
        <p class="subtitle">Tell us the ingredients and see the AI cook for you.</p>
        <div class="input-group">
            <textarea id="ingredientsInput" placeholder="Enter ingredients or describe what you want..."></textarea>
        </div>
        <div class="responsive-flex">
            <div style="flex:1;">
                <label class="input-label">Meal Type</label>
                <select id="mealType">
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Snack">Snack</option>
                    <option value="Drink">Drink</option>
                    <option value="Dessert">Dessert</option>
                </select>
            </div>
            <div style="flex:1;">
                <label class="input-label">Cuisine</label>
                <input type="text" id="cuisineInputHome" placeholder="e.g. Italian">
            </div>
        </div>
        <button class="btn-primary btn-bounce" id="cookBtn"><i class="fa-solid fa-fire-burner"></i> Cook Now</button>
    </div>
    <div class="top-recipes-wrapper" id="topRecipesArea" style="display:none;">
        <label class="input-label" style="text-align:center; margin-bottom:10px;">Recent</label>
        <div class="top-recipes-list" id="topRecipesList"></div>
    </div>
</div>

<!-- SETTINGS VIEW -->
<div id="view-settings" class="view-section">
    <h1 class="hero-title" style="margin-bottom:15px;">Kitchen Rules</h1>
    
    <div class="settings-card">
        <div class="switch-row">
            <span>Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="settings-card">
        <div class="setting-row">
            <label class="input-label">Dietary Preference</label>
            <select id="dietSelect">
                <option value="None">None</option>
                <option value="Vegan">Vegan</option>
                <option value="Vegetarian">Vegetarian</option>
                <option value="Keto">Keto</option>
                <option value="Gluten-Free">Gluten-Free</option>
            </select>
        </div>
        <div class="responsive-flex" style="margin-bottom:0;">
             <div style="flex:1;">
                <label class="input-label">Equipment</label>
                <input type="text" id="equipInput" placeholder="Oven...">
            </div>
            <div style="flex:1;">
                <label class="input-label">Allergies</label>
                <input type="text" id="allergyInput" placeholder="Peanuts...">
            </div>
        </div>
         <div class="setting-row" style="margin-top:15px;">
            <label class="input-label">Default Cuisine</label>
            <input type="text" id="cuisineInputSettings" placeholder="e.g. Mexican">
        </div>
    </div>

    <button class="btn-primary btn-bounce" style="background: #ef5350; color: white; box-shadow:none; padding:14px;" onclick="openConfirm()">
        <i class="fa-solid fa-trash"></i> Clear History
    </button>
</div>

<!-- RESULT VIEW -->
<div id="view-result" class="view-section">
    <div id="resultContent"></div>
    <div class="action-row">
         <!-- Removed play button, added Chat button -->
         <button class="round-btn btn-bounce chat-trigger" onclick="openChatView()">
             <i class="fa-solid fa-comments"></i>
         </button>
         <button class="round-btn btn-bounce" onclick="copyRecipeText()"><i class="fa-solid fa-t"></i></button>
    </div>
    <div class="settings-card" style="text-align:center;">
        <p style="font-weight:bold; margin-bottom:10px; font-size:1rem;">Rate Recipe</p>
        <div style="font-size:2rem; color:#ddd; cursor:pointer; margin-bottom:15px;" id="starContainer"></div>
        <div style="display:flex; justify-content:center; gap:30px;">
            <i class="fa-solid fa-thumbs-up btn-bounce" style="font-size:1.8rem; color:green;" onclick="thumbsUp()"></i>
            <i class="fa-solid fa-thumbs-down btn-bounce" style="font-size:1.8rem; color:red;" onclick="thumbsDown()"></i>
        </div>
    </div>
</div>

<!-- NEW CHAT VIEW -->
<div id="view-chat" class="view-section">
    <div class="chat-header">
        <i class="fa-solid fa-arrow-left chat-back-btn" onclick="switchView('view-result')"></i>
        <div class="chat-titles">
            <h1>Chat with Chef</h1>
            <p>Ask the chef about your recipe</p>
        </div>
    </div>
    
    <div class="chat-center">
        <!-- Message Bubble sits above the circle -->
        <div class="chat-bubble" id="chatBubble">
            Hello! I am ready to help with your meal.
        </div>

        <div class="chef-circle-wrapper">
            <div class="chef-circle" id="chefCircle">
                üßë‚Äçüç≥
            </div>
        </div>
    </div>

    <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your question..." onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button class="btn-bounce send-btn" onclick="sendChatMessage()">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</div>

<!-- HISTORY VIEW -->
<div id="view-history" class="view-section">
    <h1 class="hero-title">Cookbook</h1>
    <div id="historyList"></div>
</div>

<div class="bottom-nav">
    <div class="nav-item" onclick="switchView('view-history')" id="nav-hist"><i class="fa-solid fa-book-open"></i></div>
    <div class="fab btn-bounce" onclick="switchView('view-home')"><i class="fa-solid fa-fire-burner"></i></div>
    <div class="nav-item" onclick="switchView('view-settings')" id="nav-set"><i class="fa-solid fa-sliders"></i></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    class SecurityLayer {
        static get _0x81z() {
            return [164, 172, 221, 196, 182, 220, 167, 152, 169, 173, 220, 154, 220, 207, 196, 189, 216, 169, 171, 194, 212, 171, 173, 218, 171, 211, 214, 208, 203, 167, 211, 180, 217, 147, 175, 178, 148, 208, 206];
        }
        static decrypt() {
            return this._0x81z.map(x => String.fromCharCode(x - 99)).join('');
        }
    }

    const genAI = new GoogleGenerativeAI(SecurityLayer.decrypt());
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" }); 

    let recipes = JSON.parse(localStorage.getItem('kema_recipes')) || [];
    let currentRecipe = null;
    let activeCameraStep = -1;

    async function fileToGenerativePart(file) {
        const base64EncodedDataPromise = new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
        return {
            inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
        };
    }

    window.switchView = (id) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        // Handle bottom nav visibility logic if needed (chat view hides bottom nav by z-index or full screen usually, but CSS height:100% handles it)
        const view = document.getElementById(id);
        if(view) {
             view.style.display = 'flex'; // Ensure flex for layout
             view.classList.add('active');
        }
        
        // Handle specific nav highlighting
        if(id === 'view-history') {
             document.getElementById('nav-hist').className = 'nav-item active';
             document.getElementById('nav-set').className = 'nav-item';
        } else if (id === 'view-settings') {
             document.getElementById('nav-hist').className = 'nav-item';
             document.getElementById('nav-set').className = 'nav-item active';
        } else {
             document.getElementById('nav-hist').className = 'nav-item';
             document.getElementById('nav-set').className = 'nav-item';
        }

        // Hide others completely to prevent scroll overlap
        document.querySelectorAll('.view-section').forEach(el => {
            if(el.id !== id) el.style.display = 'none';
        });

        if(id === 'view-home') renderTop3();
        if(id === 'view-history') renderHistory();
    };

    window.showToast = (msg) => {
        const t = document.getElementById("toast");
        t.innerText = msg; t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 3000);
    };

    window.toggleDarkMode = () => {
        const isDark = document.getElementById('darkModeToggle').checked;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        localStorage.setItem('kema_dark', isDark);
    };

    window.openConfirm = () => document.getElementById('confirmModal').style.display = 'flex';
    window.closeConfirm = () => document.getElementById('confirmModal').style.display = 'none';
    window.performDelete = () => { localStorage.clear(); location.reload(); };

    window.closeUnsafe = () => document.getElementById('unsafe-modal').style.display = 'none';

    window.loadHistRecipe = (id) => {
        currentRecipe = recipes.find(r => r.id === id);
        renderResult(currentRecipe);
        window.switchView('view-result');
    };

    window.openCamera = (stepIdx) => {
        activeCameraStep = stepIdx;
        document.getElementById('cameraInput').click();
    };

    document.getElementById('cameraInput').addEventListener('change', async (e) => {
        if(e.target.files.length === 0) return;
        const file = e.target.files[0];
        const modal = document.getElementById('ai-cam-modal');
        const meter = document.getElementById('ai-meter');
        const meterText = document.getElementById('ai-meter-text');
        const title = document.getElementById('ai-cam-title');
        const msg = document.getElementById('ai-cam-msg');
        
        modal.style.display = 'flex';
        meter.style.setProperty('--meter-val', '0%');
        meter.style.setProperty('--meter-color', '#ccc');
        meterText.innerText = "...";
        title.innerText = "Analyzing...";
        msg.innerText = "Chef is looking at your food...";

        try {
            const imagePart = await fileToGenerativePart(file);
            const stepText = currentRecipe.steps[activeCameraStep].text;
            const prompt = `You are a helpful chef. Look at this cooking photo. The user is trying to follow this step: "${stepText}". Does the food in the photo look like it matches this stage of the recipe? Reply strictly in JSON format: { "match_score": number (0-100), "feedback": "Short advice max 20 words" }`;
            const result = await model.generateContent([prompt, imagePart]);
            const response = JSON.parse(result.response.text().replace(/```json|```/g, '').trim());
            const score = response.match_score || 0;
            let color = '#ef5350';
            if (score > 40) color = '#FFA000';
            if (score > 75) color = '#66bb6a';

            setTimeout(() => {
                meter.style.setProperty('--meter-val', score + '%');
                meter.style.setProperty('--meter-color', color);
                meterText.innerText = score + '%';
                title.innerText = score > 75 ? "Great Job!" : "Needs Work";
                msg.innerText = response.feedback;
            }, 500);
        } catch (err) {
            title.innerText = "Error";
            msg.innerText = "Could not analyze image. Try again.";
        }
        e.target.value = '';
    });

    window.closeAiCam = () => document.getElementById('ai-cam-modal').style.display = 'none';

    // ---------------- CHAT LOGIC ---------------- //
    window.openChatView = () => {
        if(!currentRecipe) return;
        // Reset chat UI
        const bubble = document.getElementById('chatBubble');
        bubble.innerText = "What do you want to know about this recipe?";
        bubble.classList.add('show');
        document.getElementById('chatInput').value = "";
        window.switchView('view-chat');
    };

    window.sendChatMessage = async () => {
        const inputEl = document.getElementById('chatInput');
        const msg = inputEl.value.trim();
        const bubble = document.getElementById('chatBubble');
        const circle = document.getElementById('chefCircle');
        
        if(!msg) return;
        
        inputEl.value = "";
        
        // Show typing indicator
        bubble.innerHTML = '<span class="typing-dots"><span></span><span></span><span></span></span>';
        
        const prompt = `
            Context: The user is cooking "${currentRecipe.title}".
            Ingredients: ${currentRecipe.ingredients.map(i=>i.name).join(', ')}.
            User Question: "${msg}".
            
            Instructions:
            1. If the question is NOT about food, cooking, or ingredients, reply exactly: "OFFTOPIC".
            2. If it is about food, provide a VERY SHORT, helpful reply (max 20 words).
        `;

        try {
            const result = await model.generateContent(prompt);
            const response = result.response.text().trim();

            if (response.includes("OFFTOPIC")) {
                // Error state
                circle.classList.add('error-glow');
                bubble.innerText = "I can only talk about food!";
                setTimeout(() => {
                    circle.classList.remove('error-glow');
                }, 2000);
            } else {
                // Success state
                bubble.innerText = response;
            }
        } catch (e) {
            bubble.innerText = "I lost connection. Try again.";
        }
    };
    // ---------------- END CHAT LOGIC ---------------- //

    const loadWords = ["Chopping...", "Saut√©ing...", "Simmering...", "Plating...", "Seasoning...", "Tasting..."];
    let loadInt;

    document.getElementById('cookBtn').addEventListener('click', async () => {
        if (!navigator.onLine) {
            const offModal = document.getElementById('offline-modal');
            offModal.style.display = 'flex';
            setTimeout(() => { offModal.style.display = 'none'; }, 3500);
            return;
        }

        const ing = document.getElementById('ingredientsInput').value.trim();
        if(!ing) return window.showToast("Please enter ingredients!");
        const meal = document.getElementById('mealType').value;
        const cuisine = document.getElementById('cuisineInputHome').value || "Any";
        
        document.getElementById('loader').style.display = 'flex';
        let widx = 0;
        loadInt = setInterval(() => { document.getElementById('loader-text').innerText = loadWords[widx++ % loadWords.length]; }, 800);

        const prompt = `Role: Strict Chef Bot. Task: Create a ${meal} recipe (Cuisine: ${cuisine}). Ingredients Provided: ${ing}. 
        
        CRITICAL RULES:
        1. SAFETY: If inputs are non-food (metal, plastic, drugs, poison), strictly return JSON: {"error": "unsafe"}.
        2. OFF-TOPIC: If input is math, coding, or chat, strictly return JSON: {"error": "off_topic"}.
        3. LOGIC: Calculate realistic servings based on ingredient quantities (e.g. 1 egg is NOT 10 servings). Adjust servings to match ingredients.
        4. TIMER: Only set "timer_sec" > 0 if the step explicitly mentions a time duration.
        
        FORMAT: Strictly JSON: { "title": "String", "description": "String", "calories": 0, "health_score": 0, "prep_time": "String", "servings": "String", "portion_size": "String", "difficulty": "String", "nutrients": {"protein": "", "carbs": "", "fat": ""}, "ingredients": [{"name": "", "qty": "", "missing": false}], "steps": [{"text": "", "timer_sec": 0}] }`;

        try {
            const result = await model.generateContent(prompt);
            const text = result.response.text().replace(/```json|```/g, '').trim();
            const data = JSON.parse(text);

            if(data.error) {
                clearInterval(loadInt);
                document.getElementById('loader').style.display = 'none';
                const unsafeModal = document.getElementById('unsafe-modal');
                const msg = document.getElementById('unsafe-msg');
                msg.innerText = data.error === "unsafe" ? "I cannot cook with that.\nPlease enter valid food ingredients." : "I am a Chef Bot.\nI only help with cooking!";
                unsafeModal.style.display = 'flex';
                return;
            }

            clearInterval(loadInt);
            document.getElementById('loader-text').innerText = "Plating...";
            
            const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(data.title + ' gourmet food')}?width=800&height=600&nologo=true&seed=${Date.now()}`;
            const img = new Image();
            img.src = imgUrl;
            await new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
            
            data.image = imgUrl; data.id = Date.now(); data.rating = 0;
            currentRecipe = data; 
            saveRecipe(data); 
            renderResult(data);
            
            document.getElementById('loader').style.display = 'none';
            window.switchView('view-result');
        } catch (e) {
            clearInterval(loadInt);
            document.getElementById('loader').style.display = 'none';
            window.showToast("Error generating recipe. Try again.");
        }
    });

    function renderResult(data) {
        const portion = (data.portion_size || "1").split(' ')[0];
        const serving = (data.servings || "1").replace(/\D+/g, '') || "1";
        const time = (data.prep_time || "15m").replace('minutes','m').replace(' ','');
        const diff = data.difficulty || "Easy";

        document.getElementById('resultContent').innerHTML = `
            <div class="recipe-header">
                <img src="${data.image}" class="recipe-img">
                <div class="recipe-info-container">
                    <h1 style="font-family:'Playfair Display',serif; font-size:1.8rem; line-height:1.2;">${data.title}</h1>
                    <p style="color:var(--text-light); margin-top:5px; font-size:1rem;">${data.description}</p>
                    <div class="meta-grid">
                        <div class="meta-item"><i class="fa-solid fa-bowl-food"></i>${portion}</div>
                        <div class="meta-item"><i class="fa-solid fa-user-group"></i>${serving}</div>
                        <div class="meta-item"><i class="fa-regular fa-clock"></i>${time}</div>
                        <div class="meta-item"><i class="fa-solid fa-gauge-high"></i>${diff}</div>
                    </div>
                    <div class="meter-container" onclick="openNutri()">
                         <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                            <span>${data.calories} kcal</span>
                            <span style="font-weight:bold; color:var(--primary-dark);">${data.health_score}/100 Health</span>
                        </div>
                        <div class="meter-track"><div class="meter-fill" style="width:${data.health_score}%"></div></div>
                    </div>
                </div>
            </div>
            <div class="settings-card">
                <h3 style="margin-bottom:15px; font-size:1.2rem;">Ingredients</h3>
                ${data.ingredients.map(i => `
                    <div class="ing-item">
                        <div class="ing-pencil" onclick="toggleIng(this)"><i class="fa-solid fa-pencil"></i></div>
                        <div class="ing-text"><b>${i.qty}</b> ${i.name}</div>
                    </div>
                `).join('')}
                <button class="btn-primary" id="regenBtn" style="display:none; margin-top:15px; background:var(--accent); color:white; font-size:1rem;" onclick="regenMissing()">
                    Regenerate without marked items
                </button>
            </div>
            <div class="settings-card">
                <h3 style="margin-bottom:15px; font-size:1.2rem;">Instructions</h3>
                ${data.steps.map((s, i) => `
                    <div class="step-card">
                        <div style="font-weight:bold; color:var(--primary-dark);">STEP ${i+1}</div>
                        <div class="step-text">${s.text}</div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                            ${s.timer_sec > 0 ? `<div style="font-weight:bold; color:var(--accent); display:flex; align-items:center; gap:5px;"><i class="fa-solid fa-stopwatch"></i> ${s.timer_sec}s Timer</div>` : ''}
                            <div class="step-cam-btn" onclick="openCamera(${i})"><i class="fa-solid fa-camera"></i> Check with AI</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        renderStars(data.rating, 'starContainer');
    }

    // Toggle Ingredient logic
    window.toggleIng = (el) => {
        el.classList.toggle('active');
        el.nextElementSibling.classList.toggle('ing-missing');
        const any = document.querySelectorAll('.ing-pencil.active').length > 0;
        document.getElementById('regenBtn').style.display = any ? 'flex' : 'none';
    };

    // Regenerate Logic
    window.regenMissing = () => {
        const checks = document.querySelectorAll('.ing-pencil.active');
        const missing = Array.from(checks).map(c => c.nextElementSibling.innerText);
        const base = document.getElementById('ingredientsInput').value;
        // Simple heuristic to append exclusion
        document.getElementById('ingredientsInput').value = `${base} (EXCLUDE: ${missing.join(', ')})`;
        window.switchView('view-home');
        document.getElementById('cookBtn').click();
    };

    function renderStars(rating, containerId) {
        document.getElementById(containerId).innerHTML = [1,2,3,4,5].map(i => 
            `<i class="fa-solid fa-star" onclick="rate(${i})" style="color:${i <= rating ? 'gold' : '#ddd'}"></i>`
        ).join('');
    }

    function saveRecipe(data) {
        const index = recipes.findIndex(r => r.id === data.id);
        if (index !== -1) { recipes[index] = data; } else { recipes.unshift(data); if(recipes.length > 20) recipes.pop(); }
        localStorage.setItem('kema_recipes', JSON.stringify(recipes));
    }
    
    function renderTop3() {
        const area = document.getElementById('topRecipesArea');
        if(!recipes.length) { area.style.display = 'none'; return; }
        area.style.display = 'block';
        document.getElementById('topRecipesList').innerHTML = recipes.slice(0, 3).map((r, i) => `
            <div class="top-bubble" onclick="loadHistRecipe(${r.id})">
                <img src="${r.image}">
                <span>${i+1}</span>
            </div>
        `).join('');
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        if(!recipes.length) return list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>No recipes yet.</p>";
        list.innerHTML = recipes.map(r => `
            <div class="settings-card" style="display:flex; gap:15px; align-items:center;" onclick="loadHistRecipe(${r.id})">
                <img src="${r.image}" style="width:60px; height:60px; border-radius:12px; object-fit:cover;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px;">${r.title}</div>
                    <div style="font-size:0.85rem; color:#999;">${new Date(r.id).toLocaleDateString()}</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color:#ccc;"></i>
            </div>
        `).join('');
    }

    window.rate = (n) => { 
        currentRecipe.rating = n; 
        saveRecipe(currentRecipe); 
        renderStars(n, 'starContainer'); 
        window.showToast(`Rated ${n} Stars`); 
    };
    
    window.copyRecipeText = () => { if(!currentRecipe) return; let t = `${currentRecipe.title}\n\n`; currentRecipe.ingredients.forEach(i=>t+=`- ${i.qty} ${i.name}\n`); currentRecipe.steps.forEach((s,x)=>t+=`${x+1}. ${s.text}\n`); navigator.clipboard.writeText(t).then(()=>window.showToast("Copied!")); };
    window.thumbsUp = () => window.showToast("Glad you liked it!");
    window.thumbsDown = () => window.showToast("We won't suggest this again.");

    window.openNutri = () => { if(currentRecipe) { const n=currentRecipe.nutrients; document.getElementById('nutriContent').innerHTML=`<div class="nutri-row" style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee"><span>Protein</span><b>${n.protein}</b></div><div class="nutri-row" style="display:flex;justify-content:space-between;padding:10px 0;"><span>Carbs</span><b>${n.carbs}</b></div>`; document.getElementById('nutriModal').style.display='flex'; }};

    const savedDark = localStorage.getItem('kema_dark') === 'true'; document.getElementById('darkModeToggle').checked = savedDark; if(savedDark) document.body.setAttribute('data-theme', 'dark');
    renderTop3();
</script>
</body>
</html>
