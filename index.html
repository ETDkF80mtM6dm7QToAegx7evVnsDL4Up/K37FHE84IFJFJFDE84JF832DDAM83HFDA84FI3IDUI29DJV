<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kema Chef</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    :root {
        --primary: #FFC107;
        --primary-dark: #FFA000;
        --accent: #FF5722;
        --bg: #FAFAFA;
        --card-bg: #FFFFFF;
        --text-main: #1a1a1a;
        --text-light: #666666;
        --border: #E0E0E0;
        --shadow: 0 5px 20px rgba(0,0,0,0.05);
        --radius: 16px;
        --nav-bg: #FFFFFF;
        --nav-height: 80px;
    }

    [data-theme="dark"] {
        --bg: #121212;
        --card-bg: #1E1E1E;
        --text-main: #FFFFFF;
        --text-light: #B0B0B0;
        --border: #333333;
        --nav-bg: #1E1E1E;
        --shadow: 0 5px 20px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'DM Sans', sans-serif;
        background-color: var(--bg);
        color: var(--text-main);
        height: 100vh;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        font-size: 15px;
    }

    .btn-bounce { transition: transform 0.1s; cursor: pointer; }
    .btn-bounce:active { transform: scale(0.96); }
    
    input, select, textarea {
        background: var(--card-bg); color: var(--text-main);
        border: 1px solid var(--border);
        font-size: 16px; 
        width: 100%;
        border-radius: 12px;
        outline: none;
        appearance: none;
        font-family: 'DM Sans', sans-serif;
    }

    header {
        padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        z-index: 100;
        flex-shrink: 0;
        height: 60px;
    }
    .logo { font-family: 'Playfair Display', serif; font-size: 1.8rem; font-weight: 900; }
    .logo span { color: var(--primary); margin-right: 10px; }

    .view-section {
        flex: 1; 
        width: 100%; 
        max-width: 600px; 
        margin: 0 auto;
        display: none; 
        padding: 10px 20px calc(var(--nav-height) + 10px) 20px;
        overflow-y: hidden; 
    }

    #view-result, #view-history {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .view-section.active { display: flex; flex-direction: column; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .hero-title { font-family: 'Playfair Display', serif; font-size: 2.2rem; line-height: 1.1; margin-bottom: 5px; }
    .subtitle { color: var(--text-light); margin-bottom: 20px; font-size: 1rem; }
    .input-label { font-size: 0.85rem; font-weight: 700; color: var(--text-light); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }

    textarea { height: 100px; padding: 14px; resize: none; margin-bottom: 15px; }
    textarea:focus { border-color: var(--primary); }
    select, input[type="text"] { padding: 12px; }

    .btn-primary {
        background: var(--primary); color: #000; border: none; width: 100%; 
        padding: 16px; border-radius: var(--radius); font-size: 1.1rem; font-weight: 700;
        box-shadow: 0 8px 20px rgba(255, 193, 7, 0.25); margin-top: 10px;
        display: flex; align-items: center; justify-content: center; gap: 8px;
    }

    .top-recipes-wrapper { margin-top: auto; padding-bottom: 10px; }
    .top-recipes-list { display: flex; justify-content: center; gap: 15px; }
    .top-bubble {
        width: 65px; height: 65px; border-radius: 50%; border: 2px solid var(--card-bg);
        box-shadow: var(--shadow); cursor: pointer; position: relative;
    }
    .top-bubble img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .top-bubble span {
        position: absolute; top: -2px; right: -2px; background: var(--primary); color: #000;
        font-size: 0.75rem; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;
        border-radius: 50%; font-weight: bold; border: 2px solid var(--card-bg);
    }

    .settings-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px; }
    .setting-row { margin-bottom: 15px; }
    .switch-row { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; font-weight: 500;}
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    .recipe-header {
        background: var(--card-bg); padding: 0 0 20px 0; border-radius: var(--radius);
        box-shadow: var(--shadow); margin-bottom: 20px; text-align: center; overflow: hidden;
    }
    .recipe-img { width: 100%; height: 250px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .recipe-info-container { padding: 0 20px; }
    
    .meta-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
    .meta-item {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: var(--bg); padding: 10px; border-radius: 12px; font-size: 0.9rem; font-weight: 600;
    }
    .meta-item i { color: var(--primary-dark); margin-bottom: 5px; font-size: 1.1rem; }

    .meter-container { margin-top: 15px; padding: 8px; border: 1px solid var(--border); border-radius: 12px; }
    .meter-track { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin-top: 5px;}
    .meter-fill { height: 100%; background: linear-gradient(90deg, #81C784, #FFB74D, #E57373); }

    .ing-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .ing-pencil { 
        width: 35px; height: 35px; margin-right: 12px; background: #f5f5f5; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: var(--text-light); cursor: pointer; font-size: 0.9rem;
    }
    .ing-pencil.active { background: var(--accent); color: white; }
    
    .step-card {
        background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 15px;
        border-left: 4px solid var(--primary); box-shadow: var(--shadow);
    }
    .step-text { font-size: 1.05rem; line-height: 1.5; }

    .action-row { display: flex; justify-content: center; gap: 20px; margin: 25px 0; }
    .round-btn {
        width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--border);
        background: var(--card-bg); color: var(--text-light); font-size: 1.4rem;
        display: flex; align-items: center; justify-content: center;
    }

    /* Cook Mode */
    #cook-mode {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--card-bg); z-index: 5000; display: none;
        padding: 15px; flex-direction: column;
    }
    .video-controls {
        display: flex; align-items: center; justify-content: center;
        padding-bottom: 30px; margin-top: auto;
    }
    .play-big { 
        width: 80px; height: 80px; background: var(--primary); border-radius: 50%; 
        color: black; display: flex; align-items: center; justify-content: center; font-size: 2rem;
        box-shadow: 0 10px 30px rgba(255, 193, 7, 0.4); border: 4px solid #fff;
    }
    .timer-display { font-size: 4rem; font-weight: 700; color: var(--accent); text-align: center; margin: 15px 0; }
    
    .swipe-hint {
        position: absolute; top: 50%; right: 20px; transform: translateY(-50%);
        color: var(--primary); font-size: 2rem; opacity: 0; pointer-events: none;
    }
    .swipe-hint.animate { animation: swipeRight 2s infinite; }
    @keyframes swipeRight { 
        0% { opacity: 0; transform: translate(0, -50%); } 
        50% { opacity: 1; transform: translate(10px, -50%); } 
        100% { opacity: 0; transform: translate(20px, -50%); } 
    }

    #loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg); z-index: 2000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
    }
    .emoji-anim { font-size: 4rem; animation: bounce 1s infinite alternate; }
    @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-15px); } }

    #toast {
        visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center;
        border-radius: 50px; padding: 12px 20px; position: fixed; z-index: 4000; left: 50%; bottom: 100px;
        transform: translateX(-50%); font-size: 0.9rem; opacity: 0; transition: opacity 0.3s;
    }
    #toast.show { visibility: visible; opacity: 1; }

    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: var(--nav-bg);
        display: flex; align-items: center; justify-content: space-evenly;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-radius: 25px 25px 0 0;
        padding-bottom: 5px;
    }
    .nav-item { font-size: 1.4rem; color: #ccc; padding: 20px; }
    .nav-item.active { color: var(--text-main); }
    .fab {
        width: 60px; height: 60px; background: var(--primary); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: #000;
        transform: translateY(-25px); border: 6px solid var(--bg); box-shadow: 0 5px 15px rgba(255,193,7,0.4);
    }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
        z-index: 3500; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
    }
    .modal-box {
        background: var(--card-bg); width: 85%; max-width: 320px; padding: 25px;
        border-radius: 20px; text-align: center; animation: fadeIn 0.3s;
    }

    .responsive-flex { display: flex; gap: 10px; margin-bottom: 15px; }
    .word-highlight { background-color: var(--primary); color: black; border-radius: 4px; padding: 0 4px; }
</style>

<script type="importmap">
  { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
</script>
</head>
<body>
<header>
    <div class="logo">Kema<span>.</span></div>
</header>

<div id="toast">Message</div>

<div class="modal-overlay" id="confirmModal">
    <div class="modal-box">
        <h3 style="margin-bottom:10px; font-size:1.3rem;">Delete Everything?</h3>
        <p style="color:var(--text-light); margin-bottom:20px; font-size: 0.9rem;">This action cannot be undone.</p>
        <button class="btn-primary" style="background:#ef5350; color:white; margin-bottom:10px; box-shadow:none; padding:12px;" onclick="performDelete()">Delete</button>
        <button class="btn-primary" style="background:transparent; color:var(--text-main); border:1px solid var(--border); box-shadow:none; padding:12px;" onclick="closeConfirm()">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="nutriModal">
    <div class="modal-box">
        <h3 style="margin-bottom:20px; font-family:'Playfair Display', serif;">Nutrition Facts</h3>
        <div id="nutriContent"></div>
        <button class="btn-primary" style="margin-top:20px; padding:12px;" onclick="document.getElementById('nutriModal').style.display='none'">Close</button>
    </div>
</div>

<div id="loader">
    <div class="emoji-anim">üç≥</div>
    <div style="margin-top:20px; font-weight:bold; color:var(--text-light); font-size:1.2rem;" id="loader-text">Cooking...</div>
</div>

<div id="view-home" class="view-section active">
    <div>
        <h1 class="hero-title">What's in your<br>kitchen?</h1>
        <p class="subtitle">Enter ingredients and let the ai cook for you!</p>
        
        <div class="input-group">
            <textarea id="ingredientsInput" placeholder="e.g. Eggs, Flour, Spinach, Milk... or I need to bake bread without yeast or an oven"></textarea>
        </div>

        <div class="responsive-flex">
            <div style="flex:1;">
                <label class="input-label">Meal Type</label>
                <select id="mealType">
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Snack">Snack</option>
                    <option value="Drink">Drink</option>
                    <option value="Dessert">Dessert</option>
                </select>
            </div>
            <div style="flex:1;">
                <label class="input-label">Cuisine</label>
                <input type="text" id="cuisineInputHome" placeholder="e.g. Italian">
            </div>
        </div>
        
        <button class="btn-primary btn-bounce" id="cookBtn">
            <i class="fa-solid fa-fire-burner"></i> Cook
        </button>
    </div>

    <div class="top-recipes-wrapper" id="topRecipesArea" style="display:none;">
        <label class="input-label" style="text-align:center; margin-bottom:10px;">Recent</label>
        <div class="top-recipes-list" id="topRecipesList"></div>
    </div>
</div>

<div id="view-settings" class="view-section">
    <h1 class="hero-title" style="margin-bottom:15px;">Kitchen Rules</h1>
    
    <div class="settings-card">
        <div class="switch-row">
            <span>Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="settings-card">
        <div class="setting-row">
            <label class="input-label">Dietary Preference</label>
            <select id="dietSelect">
                <option value="None">None</option>
                <option value="Vegan">Vegan</option>
                <option value="Vegetarian">Vegetarian</option>
                <option value="Keto">Keto</option>
                <option value="Gluten-Free">Gluten-Free</option>
            </select>
        </div>
        <div class="responsive-flex" style="margin-bottom:0;">
             <div style="flex:1;">
                <label class="input-label">Equipment</label>
                <input type="text" id="equipInput" placeholder="Oven...">
            </div>
            <div style="flex:1;">
                <label class="input-label">Allergies</label>
                <input type="text" id="allergyInput" placeholder="Peanuts...">
            </div>
        </div>
         <div class="setting-row" style="margin-top:15px;">
            <label class="input-label">Default Cuisine</label>
            <input type="text" id="cuisineInputSettings" placeholder="e.g. Mexican">
        </div>
    </div>

    <button class="btn-primary btn-bounce" style="background: #ef5350; color: white; box-shadow:none; padding:14px;" onclick="openConfirm()">
        <i class="fa-solid fa-trash"></i> Clear History
    </button>
</div>

<div id="view-result" class="view-section">
    <div id="resultContent"></div>
    
    <div class="action-row">
         <button class="round-btn btn-bounce" onclick="startCookMode()">
            <i class="fa-solid fa-play" style="padding-left:4px;"></i>
         </button>
         <button class="round-btn btn-bounce" onclick="copyRecipeText()">
            <i class="fa-solid fa-t"></i>
         </button>
    </div>

    <div class="settings-card" style="text-align:center;">
        <p style="font-weight:bold; margin-bottom:10px; font-size:1rem;">Rate Recipe</p>
        <div style="font-size:2rem; color:#ddd; cursor:pointer; margin-bottom:15px;" id="starContainer">
            <i class="fa-solid fa-star" onclick="rate(1)"></i>
            <i class="fa-solid fa-star" onclick="rate(2)"></i>
            <i class="fa-solid fa-star" onclick="rate(3)"></i>
            <i class="fa-solid fa-star" onclick="rate(4)"></i>
            <i class="fa-solid fa-star" onclick="rate(5)"></i>
        </div>
        <div style="display:flex; justify-content:center; gap:30px;">
            <i class="fa-solid fa-thumbs-up btn-bounce" style="font-size:1.8rem; color:green;" onclick="thumbsUp()"></i>
            <i class="fa-solid fa-thumbs-down btn-bounce" style="font-size:1.8rem; color:red;" onclick="thumbsDown()"></i>
        </div>
    </div>
</div>

<div id="view-history" class="view-section">
    <h1 class="hero-title">Cookbook</h1>
    <div id="historyList"></div>
</div>

<!-- Cook Mode -->
<div id="cook-mode">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
        <h2 style="font-family:'Playfair Display',serif; font-size:1.6rem;">Chef Bot</h2>
        <div id="closeCookBtn" style="padding:15px; cursor:pointer;">
             <i class="fa-solid fa-xmark" style="font-size:2rem;"></i>
        </div>
    </div>
    
    <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:0 5px; position:relative;">
        <div style="font-size:6rem; color:var(--text-light); font-weight:900; opacity:0.1; line-height:1;" id="cm-step-num">01</div>
        
        <div style="font-size:1.6rem; line-height:1.4; font-weight:500; margin:15px 0; max-height:45vh; overflow-y:auto;" id="cm-text">
            Loading...
        </div>
        
        <div id="cm-timer-box" style="display:none; width:100%;">
            <div class="timer-display" id="cm-timer">00:00</div>
            <div style="color:var(--text-light); font-size:1rem;">Timer Auto-Start</div>
        </div>

        <div class="swipe-hint" id="swipeHint">
            <i class="fa-solid fa-hand-point-right"></i>
        </div>
    </div>

    <div class="video-controls">
        <button class="play-big btn-bounce" onclick="togglePlay()" id="playBtn"><i class="fa-solid fa-play" style="margin-left:5px;"></i></button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item" onclick="switchView('view-history')" id="nav-hist"><i class="fa-solid fa-book-open"></i></div>
    <div class="fab btn-bounce" onclick="switchView('view-home')"><i class="fa-solid fa-fire-burner"></i></div>
    <div class="nav-item" onclick="switchView('view-settings')" id="nav-set"><i class="fa-solid fa-sliders"></i></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const API_KEY = "AIzaSyBv-HTWd2fBEHVT4VDS3hLwGzh6uksI9BQ"; 
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" }); 

    let recipes = JSON.parse(localStorage.getItem('kema_recipes')) || [];
    let negatives = JSON.parse(localStorage.getItem('kema_negatives')) || [];
    let currentRecipe = null;
    let isSpeaking = false;
    let stepIndex = 0;
    let timerInterval = null;
    let audioPlayer = new Audio();
    let bgMusic = new Audio('https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3'); // Free calm acoustic loop
    bgMusic.loop = true;
    bgMusic.volume = 0.2; // Low background volume

    // Swipe Logic
    let touchStartX = 0;
    let touchEndX = 0;
    const cookModeBox = document.getElementById('cook-mode');

    cookModeBox.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    }, false);

    cookModeBox.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, false);

    function handleSwipe() {
        if (touchEndX < touchStartX - 50) {
            navStep(1); // Swipe Left -> Next
        }
        if (touchEndX > touchStartX + 50) {
            navStep(-1); // Swipe Right -> Prev
        }
    }

    // Webview safe close
    document.getElementById('closeCookBtn').addEventListener('click', () => {
        closeCookMode();
    });

    window.switchView = (id) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        document.getElementById('nav-hist').className = id === 'view-history' ? 'nav-item active' : 'nav-item';
        document.getElementById('nav-set').className = id === 'view-settings' ? 'nav-item active' : 'nav-item';

        if(id === 'view-home') renderTop3();
        if(id === 'view-history') renderHistory();
    };

    window.showToast = (msg) => {
        const t = document.getElementById("toast");
        t.innerText = msg; t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 3000);
    };

    const loadWords = ["Chopping...", "Saut√©ing...", "Simmering...", "Plating...", "Seasoning...", "Tasting..."];
    let loadInt;

    document.getElementById('cookBtn').addEventListener('click', async () => {
        const ing = document.getElementById('ingredientsInput').value.trim();
        if(!ing) return showToast("Please enter ingredients!");

        const meal = document.getElementById('mealType').value;
        const cuisine = document.getElementById('cuisineInputHome').value || document.getElementById('cuisineInputSettings').value || "Any";
        const diet = document.getElementById('dietSelect').value;
        const equip = document.getElementById('equipInput').value;
        const allergy = document.getElementById('allergyInput').value;
        
        document.getElementById('loader').style.display = 'flex';
        let widx = 0;
        loadInt = setInterval(() => {
            document.getElementById('loader-text').innerText = loadWords[widx++ % loadWords.length];
        }, 800);

        const negativeStr = negatives.length ? `Do NOT make recipes similar to: ${negatives.join(', ')}.` : '';

        const prompt = `
            Role: Master Chef Bot (Kema).
            Task: Create a ${meal} recipe (Cuisine: ${cuisine}).
            Ingredients: ${ing}.
            Constraints: Diet=${diet}, Equipment=${equip}, Allergies=${allergy}.
            ${negativeStr}
            
            SAFETY: If ingredients contain drugs, hardware, chemicals, or non-food items, return JSON: {"error": "unsafe"}.
            
            FORMAT: Strictly JSON.
            JSON Structure:
            {
                "title": "String",
                "description": "Short appetizing text",
                "calories": Number,
                "health_score": Number (0-100),
                "prep_time": "String (e.g. 15m)",
                "servings": "String (e.g. 2 ppl)",
                "portion_size": "String (e.g. 1 bowl)",
                "nutrients": {"protein": "0g", "carbs": "0g", "fat": "0g"},
                "ingredients": [{"name": "Item", "qty": "Amount", "missing": false}],
                "steps": [{"text": "Instruction sentence.", "timer_sec": 0}]
            }
        `;

        try {
            const result = await model.generateContent(prompt);
            const text = result.response.text().replace(/```json|```/g, '').trim();
            const data = JSON.parse(text);

            if(data.error) throw new Error("Unsafe ingredients detected.");

            clearInterval(loadInt);
            document.getElementById('loader-text').innerText = "Plating up...";

            const imgPrompt = `gourmet dish ${data.title} ${cuisine} hyper-realistic 8k professional food photography cinematic lighting ingredients ${data.ingredients.map(i=>i.name).join(' ')}`;
            const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(imgPrompt)}?width=800&height=600&nologo=true&seed=${Date.now()}`;

            const img = new Image();
            img.src = imgUrl;
            await new Promise(r => { img.onload = r; img.onerror = r; });

            data.image = imgUrl;
            data.id = Date.now();
            data.rating = 0;

            currentRecipe = data;
            saveRecipe(data);
            renderResult(data);
            
            document.getElementById('loader').style.display = 'none';
            switchView('view-result');

        } catch (e) {
            clearInterval(loadInt);
            document.getElementById('loader').style.display = 'none';
            showToast(e.message.includes("Unsafe") ? "Unsafe ingredients rejected!" : "Error generating recipe.");
        }
    });

    function renderResult(data) {
        const html = `
            <div class="recipe-header">
                <img src="${data.image}" class="recipe-img">
                
                <div class="recipe-info-container">
                    <h1 style="font-family:'Playfair Display',serif; font-size:1.8rem; line-height:1.2;">${data.title}</h1>
                    <p style="color:var(--text-light); margin-top:5px; font-size:1rem;">${data.description}</p>
                    
                    <div class="meta-grid">
                        <div class="meta-item"><i class="fa-regular fa-clock"></i>${data.prep_time}</div>
                        <div class="meta-item"><i class="fa-solid fa-user-group"></i>${data.servings}</div>
                        <div class="meta-item"><i class="fa-solid fa-bowl-food"></i>${data.portion_size}</div>
                    </div>

                    <div class="meter-container" onclick="openNutri()">
                        <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                            <span>${data.calories} kcal</span>
                            <span style="font-weight:bold; color:var(--primary-dark);">${data.health_score}/100 Health</span>
                        </div>
                        <div class="meter-track"><div class="meter-fill" style="width:${data.health_score}%"></div></div>
                    </div>
                </div>
            </div>

            <div class="settings-card">
                <h3 style="margin-bottom:15px; font-size:1.2rem;">Ingredients</h3>
                ${data.ingredients.map((ing, i) => `
                    <div class="ing-item">
                        <div class="ing-pencil" onclick="toggleIng(this)"><i class="fa-solid fa-pencil"></i></div>
                        <div class="ing-text"><b>${ing.qty}</b> ${ing.name}</div>
                    </div>
                `).join('')}
                <button class="btn-primary" id="regenBtn" style="display:none; margin-top:15px; background:var(--accent); color:white; font-size:1rem;" onclick="regenMissing()">
                    Regenerate without marked
                </button>
            </div>

            <div class="settings-card">
                <h3 style="margin-bottom:15px; font-size:1.2rem;">Instructions</h3>
                ${data.steps.map((s, i) => `
                    <div class="step-card">
                        <div style="font-weight:bold; color:var(--primary-dark); margin-bottom:5px; font-size:0.9rem;">STEP ${i+1}</div>
                        <div class="step-text">${marked.parseInline(s.text)}</div>
                        ${s.timer_sec > 0 ? `<div style="margin-top:10px; font-weight:bold; color:var(--text-light); font-size:1rem;"><i class="fa-regular fa-clock"></i> ${s.timer_sec}s Timer</div>` : ''}
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('resultContent').innerHTML = html;
        
        if(data.rating) {
            const stars = document.querySelectorAll('#starContainer i');
            stars.forEach((s, i) => s.style.color = i < data.rating ? "gold" : "#ddd");
        } else {
            document.querySelectorAll('#starContainer i').forEach(el => el.style.color = "#ddd");
        }
    }

    window.openNutri = () => {
        if(!currentRecipe) return;
        const n = currentRecipe.nutrients;
        document.getElementById('nutriContent').innerHTML = `
            <div class="nutri-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;"><span>Calories</span><b>${currentRecipe.calories}</b></div>
            <div class="nutri-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;"><span>Protein</span><b>${n.protein}</b></div>
            <div class="nutri-row" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;"><span>Carbs</span><b>${n.carbs}</b></div>
            <div class="nutri-row" style="display:flex; justify-content:space-between; padding:10px 0;"><span>Fat</span><b>${n.fat}</b></div>
        `;
        document.getElementById('nutriModal').style.display = 'flex';
    };

    window.toggleIng = (el) => {
        el.classList.toggle('active');
        el.nextElementSibling.classList.toggle('ing-missing');
        const any = document.querySelectorAll('.ing-pencil.active').length > 0;
        document.getElementById('regenBtn').style.display = any ? 'flex' : 'none';
    };

    window.regenMissing = () => {
        const checks = document.querySelectorAll('.ing-pencil.active');
        const missing = Array.from(checks).map(c => c.nextElementSibling.innerText);
        const base = document.getElementById('ingredientsInput').value;
        document.getElementById('ingredientsInput').value = `${base} (EXCLUDE: ${missing.join(', ')})`;
        switchView('view-home');
        document.getElementById('cookBtn').click();
    };

    window.rate = (n) => {
        currentRecipe.rating = n;
        saveRecipesToStore();
        const stars = document.querySelectorAll('#starContainer i');
        stars.forEach((s, i) => s.style.color = i < n ? "gold" : "#ddd");
        showToast(`Rated ${n} Stars`);
    };

    window.thumbsUp = () => {
        showToast("Glad you liked it!");
    };
    
    window.thumbsDown = () => {
        if(!negatives.includes(currentRecipe.title)) {
            negatives.push(currentRecipe.title);
            localStorage.setItem('kema_negatives', JSON.stringify(negatives));
        }
        showToast("We won't suggest this again.");
    };

    window.startCookMode = () => {
        stepIndex = 0;
        document.getElementById('cook-mode').style.display = 'flex';
        bgMusic.play().catch(e => console.log("Music play blocked", e));
        updateCookStep();
    };

    window.closeCookMode = () => {
        audioPlayer.pause();
        bgMusic.pause();
        isSpeaking = false;
        clearInterval(timerInterval);
        document.getElementById('cook-mode').style.display = 'none';
    };

    window.navStep = (d) => {
        audioPlayer.pause();
        isSpeaking = false;
        document.getElementById('playBtn').innerHTML = '<i class="fa-solid fa-play" style="margin-left:5px;"></i>';
        stepIndex = Math.max(0, Math.min(stepIndex + d, currentRecipe.steps.length - 1));
        updateCookStep();
    };

    function updateCookStep() {
        const step = currentRecipe.steps[stepIndex];
        document.getElementById('cm-step-num').innerText = (stepIndex + 1).toString().padStart(2, '0');
        document.getElementById('cm-text').innerText = step.text;
        
        // Hint Animation logic
        const hint = document.getElementById('swipeHint');
        if(stepIndex === 0) {
            hint.style.opacity = '1';
            hint.classList.add('animate');
            setTimeout(() => { hint.style.opacity = '0'; hint.classList.remove('animate'); }, 3000);
        } else {
            hint.style.opacity = '0';
        }

        const timerBox = document.getElementById('cm-timer-box');
        if(step.timer_sec > 0) {
            timerBox.style.display = 'block';
            document.getElementById('cm-timer').innerText = formatTime(step.timer_sec);
            timerBox.dataset.sec = step.timer_sec;
            timerBox.dataset.active = "false";
        } else {
            timerBox.style.display = 'none';
            timerBox.dataset.sec = 0;
        }
        clearInterval(timerInterval);
    }

    window.togglePlay = () => {
        const btn = document.getElementById('playBtn');
        if(isSpeaking) {
            audioPlayer.pause();
            isSpeaking = false;
            btn.innerHTML = '<i class="fa-solid fa-play" style="margin-left:5px;"></i>';
        } else {
            isSpeaking = true;
            btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
            const text = currentRecipe.steps[stepIndex].text;
            
            // Using StreamElements Free TTS API (No Key Required, returns MP3)
            const safeText = encodeURIComponent(text);
            audioPlayer.src = `https://api.streamelements.com/kappa/v2/speech?voice=En_US&text=${safeText}`;
            audioPlayer.play();

            audioPlayer.onended = () => {
                isSpeaking = false;
                btn.innerHTML = '<i class="fa-solid fa-play" style="margin-left:5px;"></i>';
                // Auto Start Timer if exists
                const timerBox = document.getElementById('cm-timer-box');
                if(timerBox.dataset.sec > 0) {
                    startTimer();
                }
            };
        }
    };

    window.toggleTimer = () => {
        const timerBox = document.getElementById('cm-timer-box');
        if(timerBox.dataset.active === "true") {
            clearInterval(timerInterval);
            timerBox.dataset.active = "false";
        } else {
            startTimer();
        }
    };

    function startTimer() {
        const timerBox = document.getElementById('cm-timer-box');
        timerBox.dataset.active = "true";
        let t = parseInt(timerBox.dataset.sec);
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            t--;
            timerBox.dataset.sec = t;
            document.getElementById('cm-timer').innerText = formatTime(t);
            if(t<=0) { 
                clearInterval(timerInterval); 
                timerBox.dataset.active = "false";
                showToast("Timer Done!"); 
            }
        }, 1000);
    }

    function formatTime(s) {
        return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
    }

    function saveRecipe(data) {
        recipes.unshift(data);
        if(recipes.length > 20) recipes.pop();
        saveRecipesToStore();
    }
    function saveRecipesToStore() { localStorage.setItem('kema_recipes', JSON.stringify(recipes)); }

    function renderTop3() {
        const area = document.getElementById('topRecipesArea');
        if(!recipes.length) { area.style.display = 'none'; return; }
        area.style.display = 'block';
        
        const list = document.getElementById('topRecipesList');
        list.innerHTML = recipes.slice(0, 3).map((r, i) => `
            <div class="top-bubble" onclick="loadHistRecipe(${r.id})">
                <img src="${r.image}">
                <span>${i+1}</span>
            </div>
        `).join('');
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        if(!recipes.length) return list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>No recipes yet.</p>";
        list.innerHTML = recipes.map(r => `
            <div class="settings-card" style="display:flex; gap:15px; align-items:center;" onclick="loadHistRecipe(${r.id})">
                <img src="${r.image}" style="width:60px; height:60px; border-radius:12px; object-fit:cover;">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px;">${r.title}</div>
                    <div style="font-size:0.85rem; color:#999;">${new Date(r.id).toLocaleDateString()}</div>
                </div>
                <i class="fa-solid fa-chevron-right" style="color:#ccc;"></i>
            </div>
        `).join('');
    }

    window.loadHistRecipe = (id) => {
        currentRecipe = recipes.find(r => r.id === id);
        renderResult(currentRecipe);
        switchView('view-result');
    };

    window.toggleDarkMode = () => {
        const isDark = document.getElementById('darkModeToggle').checked;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        localStorage.setItem('kema_dark', isDark);
    };

    window.openConfirm = () => document.getElementById('confirmModal').style.display = 'flex';
    window.closeConfirm = () => document.getElementById('confirmModal').style.display = 'none';
    window.performDelete = () => { localStorage.clear(); location.reload(); };

    window.copyRecipeText = () => {
        if(!currentRecipe) return;
        let text = `${currentRecipe.title}\n\nINGREDIENTS:\n`;
        currentRecipe.ingredients.forEach(i => text += `- ${i.qty} ${i.name}\n`);
        text += `\nINSTRUCTIONS:\n`;
        currentRecipe.steps.forEach((s, i) => text += `${i+1}. ${s.text}\n`);
        
        navigator.clipboard.writeText(text).then(() => showToast("Recipe Copied!"));
    };

    const savedDark = localStorage.getItem('kema_dark') === 'true';
    document.getElementById('darkModeToggle').checked = savedDark;
    if(savedDark) document.body.setAttribute('data-theme', 'dark');
    
    renderTop3();
</script>
</body>
</html>
